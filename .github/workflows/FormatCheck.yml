name: "Reusable Format Checking Workflow"

on:
  workflow_call:
    inputs:
      directory:
        description: "The directory on which ITensorFormatter needs to be run"
        default: "."
        required: false
        type: string
        description: "Julia version"
        default: "1"
        required: false
        type: string
      concurrent-jobs:
        description: "Run jobs concurrently"
        default: false
        required: false
        type: boolean
      cancel-in-progress:
        description: "Cancel jobs in-progress in favor of a new one in the same concurrency group"
        default: true
        required: false
        type: boolean

concurrency:
  group: "${{ inputs.concurrent-jobs && github.run_id || github.ref  }}:${{ github.workflow }}"
  cancel-in-progress: ${{ !inputs.concurrent-jobs && inputs.cancel-in-progress }}

jobs:
  format-check:
    name: "Check Formatting"
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: write
      pull-requests: write

    steps:
      - name: Check out repository
        uses: actions/checkout@v5
        with:
          ref: ${{github.event.pull_request.head.ref}}
          repository: ${{github.event.pull_request.head.repo.full_name}}
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/${{ github.repository }}
          git fetch upstream

      - name: Setup Julia
        uses: julia-actions/setup-julia@v2
        with:
          version: '${{ inputs.julia-version }}'
          arch: 'x64'

      - uses: julia-actions/cache@v2

      - name: Install ITensorFormatter
        run: |
          julia -e '
            using Pkg
            Pkg.Registry.add("General")
            Pkg.Registry.add(; url = "https://github.com/ITensor/ITensorRegistry")
            Pkg.Apps.add("ITensorFormatter")
          '
          echo "$HOME/.julia/bin" >> $GITHUB_PATH

      - name: Run ITensorFormatter
        id: format
        run: |
          set +e
          itfmt "${{ inputs.directory }}"
          FORMAT_EXIT=$?
          if [ $FORMAT_EXIT -ne 0 ]; then
            echo "exit_code=2" >> $GITHUB_OUTPUT
            echo "diff=" >> $GITHUB_OUTPUT
            exit 1
          fi

          # Only report diff for files touched by the PR
          MERGE_BASE=$(git merge-base upstream/${{ github.base_ref }} HEAD) || exit 1
          CHANGED_FILES=$(git diff --name-only $MERGE_BASE HEAD)
          DIFF=$(git diff -- $CHANGED_FILES)
          if [ -n "$DIFF" ]; then
            EXIT_CODE=1
          else
            EXIT_CODE=0
          fi

          echo "exit_code=$EXIT_CODE" >> $GITHUB_OUTPUT
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$DIFF" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Find comment
        uses: peter-evans/find-comment@v3
        id: find-comment
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- format-check-summary -->'

      - name: Comment formatting suggestions
        if: steps.format.outputs.exit_code == 1
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- format-check-summary -->

            Your PR requires formatting changes to meet the project's style guidelines.
            Please run the [ITensorFormatter](https://github.com/ITensor/ITensorFormatter.jl) to apply these changes.

            <details>
            <summary>Click here to view the suggested changes.</summary>

            ~~~diff
            ${{ steps.format.outputs.diff }}
            ~~~

            </details>
          edit-mode: replace

      - name: Update stale comment
        if: steps.format.outputs.exit_code == 0 && steps.find-comment.outputs.comment-id
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.find-comment.outputs.comment-id }}
          issue-number: ${{ github.event.pull_request.number }}
          body: |
            <!-- format-check-summary -->

            Your PR no longer requires formatting changes. Thank you for your contribution!
          edit-mode: replace

      - name: Propagate exit code
        run: |
          exit ${{ steps.format.outputs.exit_code }}
