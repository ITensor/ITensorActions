name: "Reusable Registrator Workflow"

on:
  workflow_call:
    inputs:
      localregistry:
        description: "Local registry repo (owner/name) used when the package is not in General."
        required: true
        type: string
      julia-version:
        description: "Julia version"
        default: "1"
        required: false
        type: string
    secrets:
      REGISTRATOR_KEY:
        required: true

jobs:
  registrator:
    name: "Register package version"
    runs-on: ubuntu-latest

    steps:
      - name: Checkout package
        uses: actions/checkout@v4
        with:
          path: package
          fetch-depth: 0

      - name: "Setup Julia ${{ inputs.julia-version }}"
        uses: julia-actions/setup-julia@v2
        with:
          version: "${{ inputs.julia-version }}"
          arch: "${{ runner.arch }}"

      - uses: julia-actions/cache@v2

      - name: "Read uuid/version and detect bump + semver-breaking"
        id: meta
        working-directory: package
        shell: julia --color=yes {0}
        env:
          OLD_REF: ${{ github.event.before }}
        run: |
          import Pkg

          project = Pkg.Types.read_project("Project.toml")
          uuid = string(project.uuid)
          newv = string(project.version)

          old_ref = get(ENV, "OLD_REF", "")
          if isempty(old_ref) || old_ref == "0000000000000000000000000000000000000000"
            old_ref = "HEAD^"
          end

          oldv = ""
          try
            old_toml = readchomp(`git show $(old_ref):Project.toml`)
            old_project = Pkg.Types.read_project(IOBuffer(old_toml))
            oldv = string(old_project.version)
          catch
            # Leave oldv empty if we can't read the previous version
          end

          bumped = !isempty(oldv) && oldv != newv

          is_breaking = false
          if bumped
            o = try VersionNumber(oldv) catch; nothing end
            n = try VersionNumber(newv) catch; nothing end
            if o !== nothing && n !== nothing
              if o.major == 0
                # 0.x.y -> 0.(x+1).* is breaking
                is_breaking = (n.major == 0) && (n.minor > o.minor)
              else
                # x.y.z -> (x+1).*.* is breaking
                is_breaking = (n.major > o.major)
              end
            end
          end

          open(ENV["GITHUB_OUTPUT"], "a") do io
            println(io, "uuid=$uuid")
            println(io, "old_version=$oldv")
            println(io, "new_version=$newv")
            println(io, "version_bumped=$(bumped)")
            println(io, "is_breaking=$(is_breaking)")
          end

      - name: "Check if UUID is in General"
        id: general
        if: steps.meta.outputs.version_bumped == 'true'
        env:
          GH_TOKEN: ${{ secrets.REGISTRATOR_KEY }}
          UUID: ${{ steps.meta.outputs.uuid }}
        shell: bash
        run: |
          set -euo pipefail
          in_general=$(gh api "/search/code?q=${UUID}+repo:JuliaRegistries/General+path:Registry.toml" --jq '.total_count > 0')
          echo "in_general=${in_general}" >> "$GITHUB_OUTPUT"

      - name: "Trigger Registrator (General)"
        if: steps.meta.outputs.version_bumped == 'true' && steps.general.outputs.in_general == 'true'
        env:
          GH_TOKEN: ${{ secrets.REGISTRATOR_KEY }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          NEWVER: ${{ steps.meta.outputs.new_version }}
          IS_BREAKING: ${{ steps.meta.outputs.is_breaking }}
        shell: bash
        run: |
          set -euo pipefail
          subject=$(git -C package log -1 --pretty=%s)

          if [ "$IS_BREAKING" = "true" ]; then
            body="@JuliaRegistrator register

Release notes:
- breaking: ${subject} (v${NEWVER})"
          else
            body="@JuliaRegistrator register"
          fi

          gh api -X POST "repos/${REPO}/commits/${SHA}/comments" -f body="$body"

      # ---- Local registry path (same behavior as current ITensorActions Registrator.yml) ----

      - name: "Add the General registry via Git"
        if: steps.meta.outputs.version_bumped == 'true' && steps.general.outputs.in_general != 'true'
        shell: julia --color=yes {0}
        run: |
          import Pkg
          ENV["JULIA_PKG_SERVER"] = ""
          Pkg.Registry.add("General")

      - name: Checkout local registry
        if: steps.meta.outputs.version_bumped == 'true' && steps.general.outputs.in_general != 'true'
        uses: actions/checkout@v4
        with:
          repository: "${{ inputs.localregistry }}"
          path: registry

      - name: Install LocalRegistry.jl
        if: steps.meta.outputs.version_bumped == 'true' && steps.general.outputs.in_general != 'true'
        shell: julia --project --color=yes {0}
        run: |
          import Pkg
          Pkg.add(; name="LocalRegistry",
                   uuid="89398ba2-070a-4b16-a995-9893c55d93cf",
                   version="0.5.7")

      - name: Update local registry
        if: steps.meta.outputs.version_bumped == 'true' && steps.general.outputs.in_general != 'true'
        shell: julia --project --color=yes {0}
        run: |
          using LocalRegistry
          register("./package"; registry="./registry", commit=false, push=false)

      - name: Create PR to registry
        if: steps.meta.outputs.version_bumped == 'true' && steps.general.outputs.in_general != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          path: registry
          branch: "registrator/${{ github.repository }}"
          title: "New package version: ${{ github.repository }}"
          token: "${{ secrets.REGISTRATOR_KEY }}"
          delete-branch: true
