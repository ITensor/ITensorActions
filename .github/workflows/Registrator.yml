name: "Reusable Registrator Workflow"

on:
  workflow_call:
    inputs:
      julia-version:
        description: "Julia version"
        required: false
        default: "1"
        type: string
      localregistry:
        description: "Local registry repo (owner/name) used when the package is not in General."
        required: false
        default: ""
        type: string
    secrets:
      # Only needed for the local-registry path (checkout + PR). Not needed for General.
      REGISTRATOR_KEY:
        required: false

jobs:
  registrator:
    name: "Register package version"
    runs-on: ubuntu-latest

    steps:
      - name: "Setup Julia ${{ inputs.julia-version }}"
        uses: julia-actions/setup-julia@v2
        with:
          version: "${{ inputs.julia-version }}"
          arch: ${{ runner.arch }}

      - uses: julia-actions/cache@v2
        with:
          delete-old-caches: false

      - name: Checkout package
        uses: actions/checkout@v4
        with:
          path: package
          fetch-depth: 0

      - name: Decide route (General vs local) + validate version bump
        id: meta
        env:
          OLD_REF: ${{ github.event.before }}
        shell: julia --color=yes {0}
        run: |
          using TOML
          import Pkg

          function parse_version(s::AbstractString, label::AbstractString)
              try
                  return VersionNumber(s)
              catch err
                  error("Invalid $label version '$s' in Project.toml: $err")
              end
          end

          function valid_bump(o::VersionNumber, n::VersionNumber)
              # Only called when n > o
              if n.major == o.major && n.minor == o.minor
                  return (n.patch == o.patch + 1), "expected patch bump by 1"
              elseif n.major == o.major
                  return (n.minor == o.minor + 1 && n.patch == 0), "expected minor bump by 1 with patch reset to 0"
              else
                  return (n.major == o.major + 1 && n.minor == 0 && n.patch == 0), "expected major bump by 1 with minor/patch reset to 0"
              end
          end

          let
              new = TOML.parsefile("package/Project.toml")
              uuid = get(new, "uuid", "")
              newv_str = get(new, "version", "")

              isempty(uuid) && error("Project.toml is missing uuid")
              isempty(newv_str) && error("Project.toml is missing version")

              newv = parse_version(newv_str, "new")
              subject = replace(readchomp(`git -C package log -1 --pretty=%s HEAD`), ['\n','\r'] => ' ')

              # Determine previous ref
              old_ref = get(ENV, "OLD_REF", "")
              if isempty(old_ref) || old_ref == "0000000000000000000000000000000000000000"
                  try
                      old_ref = readchomp(`git -C package rev-parse HEAD^`)
                  catch
                      old_ref = ""
                  end
              end

              oldv_str = ""
              if !isempty(old_ref)
                  try
                      old_toml = readchomp(`git -C package show $old_ref:Project.toml`)
                      oldv_str = get(TOML.parse(old_toml), "version", "")
                  catch err
                      # Don't hard-fail on missing old Project.toml; just skip strict validation.
                      println(stderr, "Warning: could not read Project.toml at ref '$old_ref' (treating as no prior version): $err")
                      oldv_str = ""
                  end
              end

              route = "none"
              is_breaking = false
              skip_reason = ""

              if !isempty(oldv_str)
                  oldv = parse_version(oldv_str, "old")

                  if newv == oldv
                      route = "none"
                      skip_reason = "Project.toml version unchanged ($newv_str)"
                  elseif newv < oldv
                      route = "none"
                      skip_reason = "Project.toml version decreased ($oldv_str -> $newv_str); skipping registration"
                  else
                      ok, why = valid_bump(oldv, newv)
                      ok || error("Invalid version bump: $oldv_str -> $newv_str ($why)")

                      # Breaking if: major bump OR (0.x) minor bump
                      is_breaking = (newv.major > oldv.major) ||
                                    (oldv.major == 0 && newv.major == 0 && newv.minor > oldv.minor)

                      ENV["JULIA_PKG_SERVER"] = ""
                      Pkg.Registry.add("General")

                      general_toml = joinpath(first(DEPOT_PATH), "registries", "General", "Registry.toml")
                      general = TOML.parsefile(general_toml)
                      in_general = haskey(get(general, "packages", Dict{String,Any}()), uuid)

                      route = in_general ? "general" : "local"
                  end
              else
                  # No prior version found to compare against; proceed to route decision.
                  ENV["JULIA_PKG_SERVER"] = ""
                  Pkg.Registry.add("General")

                  general_toml = joinpath(first(DEPOT_PATH), "registries", "General", "Registry.toml")
                  general = TOML.parsefile(general_toml)
                  in_general = haskey(get(general, "packages", Dict{String,Any}()), uuid)

                  route = in_general ? "general" : "local"
              end

              open(ENV["GITHUB_OUTPUT"], "a") do io
                  println(io, "route=$route")
                  println(io, "new_version=$newv_str")
                  println(io, "is_breaking=$is_breaking")
                  println(io, "subject=$subject")
                  println(io, "skip_reason=$skip_reason")
              end
          end

      - name: Summary (skipped)
        if: steps.meta.outputs.route == 'none'
        run: |
          {
            echo "### Registrator"
            echo "- Skipped: ${{ steps.meta.outputs.skip_reason }}"
          } >> "$GITHUB_STEP_SUMMARY"

      # ---- General registry path ----

      - name: Compose Registrator commit comment
        if: steps.meta.outputs.route == 'general'
        shell: bash
        run: |
          {
            echo "@JuliaRegistrator register"
            if [ "${{ steps.meta.outputs.is_breaking }}" = "true" ]; then
              echo ""
              echo "Release notes:"
              echo "- breaking: ${{ steps.meta.outputs.subject }} (v${{ steps.meta.outputs.new_version }})"
            fi
          } > registrator-comment.md

      - name: Trigger Registrator (General)
        if: steps.meta.outputs.route == 'general'
        id: cc
        uses: peter-evans/commit-comment@v4
        with:
          token: ${{ github.token }}
          body-path: registrator-comment.md

      - name: Summary (General)
        if: steps.meta.outputs.route == 'general'
        run: |
          {
            echo "### Registrator"
            echo "- Route: General"
            echo "- Version: v${{ steps.meta.outputs.new_version }}"
            echo "- Commit: \`${{ github.sha }}\`"
            echo "- Commit comment id: ${{ steps.cc.outputs.comment-id }}"
            if [ "${{ steps.meta.outputs.is_breaking }}" = "true" ]; then
              echo "- Marked as breaking"
            fi
          } >> "$GITHUB_STEP_SUMMARY"

      # ---- Local registry path ----

      - name: Validate local registry input
        if: steps.meta.outputs.route == 'local' && inputs.localregistry == ''
        run: |
          echo "inputs.localregistry is required when the package is not in General." >&2
          exit 1

      - name: Validate REGISTRATOR_KEY (local registry)
        if: steps.meta.outputs.route == 'local'
        env:
          REGISTRATOR_KEY: ${{ secrets.REGISTRATOR_KEY }}
        shell: bash
        run: |
          if [ -z "$REGISTRATOR_KEY" ]; then
            echo "secrets.REGISTRATOR_KEY is required for the local registry path (checkout + PR)." >&2
            exit 1
          fi

      - name: Checkout local registry
        if: steps.meta.outputs.route == 'local'
        uses: actions/checkout@v4
        with:
          repository: "${{ inputs.localregistry }}"
          path: registry
          token: "${{ secrets.REGISTRATOR_KEY }}"

      - name: Update local registry
        if: steps.meta.outputs.route == 'local'
        shell: julia --color=yes {0}
        run: |
          import Pkg
          Pkg.activate(mktempdir())
          Pkg.add(Pkg.PackageSpec(name="LocalRegistry",
                                  uuid="89398ba2-070a-4b16-a995-9893c55d93cf",
                                  version="0.5.7"))
          using LocalRegistry
          register("./package"; registry="./registry", commit=false, push=false)

      - name: Create PR to registry
        if: steps.meta.outputs.route == 'local'
        id: cpr
        uses: peter-evans/create-pull-request@v7
        with:
          path: registry
          branch: "registrator/${{ github.repository }}"
          title: "New package version: ${{ github.repository }}"
          token: "${{ secrets.REGISTRATOR_KEY }}"
          delete-branch: true

      - name: Summary (Local registry)
        if: steps.meta.outputs.route == 'local'
        run: |
          {
            echo "### Registrator"
            echo "- Route: Local registry (\`${{ inputs.localregistry }}\`)"
            echo "- Version: v${{ steps.meta.outputs.new_version }}"
            if [ -n "${{ steps.cpr.outputs.pull-request-url }}" ]; then
              echo "- PR (${{
                steps.cpr.outputs.pull-request-operation
              }}): ${{ steps.cpr.outputs.pull-request-url }}"
            else
              echo "- PR: none (no changes)"
            fi
          } >> "$GITHUB_STEP_SUMMARY"
