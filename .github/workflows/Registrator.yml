name: "Reusable Registrator Workflow"

on:
  workflow_call:
    inputs:
      julia-version:
        description: "Julia version"
        default: "1"
        required: false
        type: string
      localregistry:
        description: "Local registry repo (owner/name) used when the package is not in General."
        required: true
        type: string
    secrets:
      REGISTRATOR_KEY:
        required: true

jobs:
  registrator:
    name: "Register package version"
    runs-on: ubuntu-latest
    steps:
      - name: "Setup Julia ${{ inputs.julia-version }}"
        uses: julia-actions/setup-julia@v2
        with:
          version: "${{ inputs.julia-version }}"

      - name: "Add the General registry via Git"
        run: |
          import Pkg
          ENV["JULIA_PKG_SERVER"] = ""
          Pkg.Registry.add("General")
        shell: julia --color=yes {0}

      - name: Checkout package
        uses: actions/checkout@v4
        with:
          path: package
          fetch-depth: 0

      - name: "Detect version bump, semver-breaking, and whether UUID is in General"
        id: meta
        env:
          OLD_REF: ${{ github.event.before }}
        shell: julia --color=yes {0}
        run: |
          import TOML

          new = TOML.parsefile("package/Project.toml")
          uuid = get(new, "uuid", "")
          newv = get(new, "version", "")

          old_ref = get(ENV, "OLD_REF", "")
          if isempty(old_ref) || old_ref == "0000000000000000000000000000000000000000"
            old_ref = "HEAD^"
          end

          oldv = ""
          try
            old_toml = readchomp(`git -C package show $old_ref:Project.toml`)
            oldv = get(TOML.parse(old_toml), "version", "")
          catch
            oldv = ""
          end

          bumped = !isempty(oldv) && !isempty(newv) && oldv != newv

          is_breaking = false
          if bumped
            try
              o = VersionNumber(oldv)
              n = VersionNumber(newv)
              is_breaking = (o.major == 0) ? (n.major == 0 && n.minor > o.minor) : (n.major > o.major)
            catch
              is_breaking = false
            end
          end

          general_registry_toml = joinpath(first(DEPOT_PATH), "registries", "General", "Registry.toml")
          general = TOML.parsefile(general_registry_toml)
          in_general = haskey(general["packages"], uuid)

          open(ENV["GITHUB_OUTPUT"], "a") do io
            println(io, "new_version=$newv")
            println(io, "version_bumped=$bumped")
            println(io, "is_breaking=$is_breaking")
            println(io, "in_general=$in_general")
          end

      - name: "Trigger Registrator (General)"
        if: steps.meta.outputs.version_bumped == 'true' && steps.meta.outputs.in_general == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REGISTRATOR_KEY }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const sha = context.sha;

            const newv = "${{ steps.meta.outputs.new_version }}";
            const isBreaking = "${{ steps.meta.outputs.is_breaking }}" === "true";

            let body = "@JuliaRegistrator register";
            if (isBreaking) {
              const { data: commit } = await github.rest.repos.getCommit({ owner, repo, ref: sha });
              const subject = commit.commit.message.split("\n")[0];
              body += `\n\nRelease notes:\n- breaking: ${subject} (v${newv})`;
            }

            await github.rest.repos.createCommitComment({ owner, repo, commit_sha: sha, body });

      # ---- Local registry path (unchanged behavior, just gated) ----

      - name: Checkout local registry
        if: steps.meta.outputs.version_bumped == 'true' && steps.meta.outputs.in_general != 'true'
        uses: actions/checkout@v4
        with:
          repository: "${{ inputs.localregistry }}"
          path: registry

      - name: Install LocalRegistry.jl
        if: steps.meta.outputs.version_bumped == 'true' && steps.meta.outputs.in_general != 'true'
        run: |
          import Pkg
          name = "LocalRegistry"
          uuid = "89398ba2-070a-4b16-a995-9893c55d93cf"
          version = "0.5.7"
          Pkg.add(; name, uuid, version)
        shell: julia --project --color=yes {0}

      - name: Update local registry
        if: steps.meta.outputs.version_bumped == 'true' && steps.meta.outputs.in_general != 'true'
        run: |
          using LocalRegistry
          package = "./package"
          registry = "./registry"
          register(package; registry, commit=false, push=false)
        shell: julia --project --color=yes {0}

      - name: Create PR to registry
        if: steps.meta.outputs.version_bumped == 'true' && steps.meta.outputs.in_general != 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          path: registry
          branch: "registrator/${{ github.repository }}"
          title: "New package version: ${{ github.repository }}"
          token: "${{ secrets.REGISTRATOR_KEY }}"
          delete-branch: true
