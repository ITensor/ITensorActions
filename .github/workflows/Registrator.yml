name: "Reusable Registrator Workflow"

on:
  workflow_call:
    inputs:
      julia-version:
        description: "Julia version"
        required: false
        default: "1"
        type: string
      localregistry:
        description: "Local registry repo (owner/name) used when the package is not in General."
        required: true
        type: string
    secrets:
      REGISTRATOR_KEY:
        required: true

jobs:
  registrator:
    name: "Register package version"
    runs-on: ubuntu-latest

    steps:
      - name: "Setup Julia ${{ inputs.julia-version }}"
        uses: julia-actions/setup-julia@v2
        with:
          version: "${{ inputs.julia-version }}"

      - uses: julia-actions/cache@v2

      - name: Checkout package
        uses: actions/checkout@v4
        with:
          path: package
          fetch-depth: 0

      - name: Decide route (General vs local) + semver-breaking
        id: meta
        env:
          OLD_REF: ${{ github.event.before }}
        shell: julia --color=yes {0}
        run: |
          using TOML
          import Pkg

          # New metadata
          new = TOML.parsefile("package/Project.toml")
          uuid = get(new, "uuid", "")
          newv = get(new, "version", "")

          # Old metadata (prefer "before push" SHA; fallback to HEAD^)
          old_ref = get(ENV, "OLD_REF", "")
          if isempty(old_ref) || old_ref == "0000000000000000000000000000000000000000"
            old_ref = "HEAD^"
          end

          oldv = ""
          try
            old_toml = readchomp(`git -C package show $old_ref:Project.toml`)
            oldv = get(TOML.parse(old_toml), "version", "")
          catch
            oldv = ""
          end

          bumped = !isempty(oldv) && !isempty(newv) && (oldv != newv)

          route = "none"
          is_breaking = false

          if bumped
            # SemVer-breaking rule:
            #   0.x.y -> 0.(x+1).*  is breaking
            #   x.y.z -> (x+1).*.*  is breaking (x >= 1)
            try
              o = VersionNumber(oldv)
              n = VersionNumber(newv)
              is_breaking = (o.major == 0) ? (n.major == 0 && n.minor > o.minor) : (n.major > o.major)
            catch
              is_breaking = false
            end

            # Ensure General is available locally (via git, not Pkg server)
            ENV["JULIA_PKG_SERVER"] = ""
            Pkg.Registry.add("General")

            # Determine if UUID is in General
            general_toml = joinpath(first(DEPOT_PATH), "registries", "General", "Registry.toml")
            general = TOML.parsefile(general_toml)
            in_general = haskey(get(general, "packages", Dict{String,Any}()), uuid)

            route = in_general ? "general" : "local"
          end

          open(ENV["GITHUB_OUTPUT"], "a") do io
            println(io, "route=$route")
            println(io, "new_version=$newv")
            println(io, "is_breaking=$is_breaking")
          end

      - name: Trigger Registrator (General)
        if: steps.meta.outputs.route == 'general'
        env:
          TOKEN: ${{ secrets.REGISTRATOR_KEY }}
          REPO: ${{ github.repository }}
          SHA: ${{ github.sha }}
          NEWVER: ${{ steps.meta.outputs.new_version }}
          IS_BREAKING: ${{ steps.meta.outputs.is_breaking }}
        shell: julia --color=yes {0}
        run: |
          using Downloads

          function json_escape(s::AbstractString)
            io = IOBuffer()
            for c in s
              if c == '\\'
                print(io, "\\\\")
              elseif c == '"'
                print(io, "\\\"")
              elseif c == '\n'
                print(io, "\\n")
              elseif c == '\r'
                print(io, "\\r")
              elseif c == '\t'
                print(io, "\\t")
              else
                print(io, c)
              end
            end
            return String(take!(io))
          end

          subject = readchomp(`git -C package log -1 --pretty=%s`)
          newv = ENV["NEWVER"]
          is_breaking = (ENV["IS_BREAKING"] == "true")

          body = "@JuliaRegistrator register"
          if is_breaking
            # Only include release notes for breaking releases; must mention "breaking".
            body *= "\n\nRelease notes:\n- breaking: $(subject) (v$(newv))"
          end

          url = "https://api.github.com/repos/$(ENV["REPO"])/commits/$(ENV["SHA"])/comments"
          payload = "{\"body\":\"$(json_escape(body))\"}"

          headers = [
            "Accept" => "application/vnd.github+json",
            "Content-Type" => "application/json",
            "Authorization" => "Bearer $(ENV["TOKEN"])",
            "X-GitHub-Api-Version" => "2022-11-28",
            "User-Agent" => "ITensorActions-Registrator"
          ]

          Downloads.request(url; method="POST", headers=headers, data=payload)

      # ---- Local registry path (unchanged behavior) ----

      - name: Checkout local registry
        if: steps.meta.outputs.route == 'local'
        uses: actions/checkout@v4
        with:
          repository: "${{ inputs.localregistry }}"
          path: registry
          token: "${{ secrets.REGISTRATOR_KEY }}"

      - name: Update local registry
        if: steps.meta.outputs.route == 'local'
        shell: julia --project --color=yes {0}
        run: |
          import Pkg
          Pkg.add(; name="LocalRegistry",
                   uuid="89398ba2-070a-4b16-a995-9893c55d93cf",
                   version="0.5.7")
          using LocalRegistry
          register("./package"; registry="./registry", commit=false, push=false)

      - name: Create PR to registry
        if: steps.meta.outputs.route == 'local'
        uses: peter-evans/create-pull-request@v7
        with:
          path: registry
          branch: "registrator/${{ github.repository }}"
          title: "New package version: ${{ github.repository }}"
          token: "${{ secrets.REGISTRATOR_KEY }}"
          delete-branch: true
